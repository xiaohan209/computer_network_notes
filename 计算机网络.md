# 计算机网络

## 第一章 概述

计算机网络由若干节点和链路组成，是一些互相连接的、自洽的、计算机集合

### 交换

电路交换：建立连接$\rightarrow$通话$\rightarrow$释放连接，通话时间内两用户始终占用资源，传输效率低

分组交换：采用存储转发技术，整块数据为报文message，加上首部header，变为分组packet，路由器负责转发分组。优点高效、灵活、迅速、可靠

![](./1/电路报文分组.png)

### 分类

网络作用范围分类：

1. WAN：几十到几千千米，广域网
2. MAN：5~50km，城域网
3. LAN：1km左右，局域网
4. PAN：10m左右，个人网

网络使用者分类：

1. 公用网

2. 专用网

   

### 性能

1. 比特率(bit rate)：单位bit/s，额定速率标准速率，$K=10^{3},M=10^{6}$

2. 带宽(bandwidth)：第一种是包含的各种不同频率成分所占据频率范围，第二种是最高数据率

3. 吞吐量(throughput)：某个网络单位时间内实际数据通过量

4. 时延(delay)：

   1. 发送时延：发送第一帧到最后一帧数据的时间，$发送时延=\frac{数据帧长度(bit)}{发送速率(bit/s)}$

   2. 传播时延：电磁波传播时间，$传播时延 = \frac{信道长度(m)}{电磁波速率(m/s)}$

   3. 处理时延

   4. 排队时延：路由器输入队列中等待的时间

      ![](./1/时延.png)

5. 时延带宽积(BDP)：$BDP=传播时延*带宽$

6. 往返时间(RTT)：确认消息走一圈的时间

7. 利用率(U)：$D=\frac{D_0}{1-U}$



### 协议

#### 要素：

1. 语法：数据与控制信息的结构格式
2. 语义：需要发出何种控制信息，如何响应
3. 同步：事件顺序的说明

#### 分层

![](./1/分层.png)

1. 应用层：进程交互规则，DNS，HTTP，SMTP，应用层数据单元为报文
2. 运输层：通用的数据运送
   1. TCP：面向连接，可靠的，传输单位报文段
   2. UDP：无连接的，尽最大努力的，传输单位用户数据报
3. 网络层：为不同主机服务，把数据封装为分组或包传送，IP协议
4. 数据链路层：单位为帧，包括数据信息和控制信息
5. 物理层：单位为比特

#### 特点

下面的协议对上面的实体透明

同一系统相邻两层实体进行交互的地方成为服务访问点SAP



## 第二章 物理层

### 物理层概念

1. 机械特性：形状尺寸、引脚排列等
2. 电气特性：各电缆线上电压范围
3. 功能特性：某条线上某个电压的定义
4. 过程特性：不同功能可能出现的事件顺序

### 信道

#### 种类

单向通信：又称单工

双向交替通信：又称半双工

双向同时通信：又称全双工

#### 极限容量

限制码元传输速率因素：

1. 信号能通过频率范围：高频分量往往不能通过低频分量，产生码间串扰，信道频带越宽，通过的高频信号分量越多，传输速率越高。理想低通信道$最大传输率=2Hlog_2V$，H为信道带宽，V为信号电平级数（信号状态数）
2. 信噪比：信号平均功率与噪声平均功率比，记为S/N，单位dB。
   $信噪比(db为单位)=10log_{10}{S/N}$。
   信道极限传输速率$C=Wlog_{2}{(1+S/N)}$，W为信道带宽(单位Hz)，S为信道内所传信号平均功率，N为信道内高斯噪声功率。公式意义：只要信息传输速率低于信道极限传输速率，就存在某种方法实现无差错传输。

### 调制

基带调制：称为编码

载波调制：带通调制，频率调高

调幅、调频、调相

![](./2/调制.png)

### 常用编码方式

1. 不归零制：正电平为1，负电平为0
2. 归零制：正脉冲为1，负脉冲为0
3. 曼彻斯特编码：周期中心向上跳为0，向下跳为0，
4. 差分曼彻斯特：边界有跳变为0，无跳变为1

![](./2/编码方式.png)

### 传输媒体

![](./2/电磁波频谱.png)

#### 导引型（有线）

##### 双绞线

模拟传输和数字传输皆可以，模拟传输需要放大器，数字传输需要中继器

| 绞合线类别  |  带宽  |         线缆特点          |               典型应用               |
| :---------: | :----: | :-----------------------: | :----------------------------------: |
|      3      | 16MHz  |       2对4芯双绞线        | 模拟电话；曾用于传统以太网(10Mbit/s) |
|      4      | 20MHz  |       4对8芯双绞线        |           曾用于令牌局域网           |
|      5      | 100MHz |    与4类相比增加绞合度    |     传输速率不超过100Mbit/s应用      |
| 5E（超5类） | 125MHz |     与5类相比衰减更小     |      传输速率不超过1Gbit/s应用       |
|      6      | 250MHz | 与5类相比改善了串扰等性能 |       传输速率高于1Gbit/s应用        |
|      7      | 600MHz |      使用屏蔽双绞线       |       传输速率高于10Gbit/s应用       |

##### 同轴电缆

较好抗干扰，传输高速率数据，一般用在小区有线电视网

##### 光缆

光纤通信就是用光导纤维传递光脉冲进行通信。中间纤芯有较高折射率，发生全发射。

存在多条不同角度入射光线在一条光纤传输，称为多模光纤。光脉冲在多模光纤传输时会展宽，只适用于近距离传输。

光纤减小到一个波长的宽度，则不会发生反射，成为单模光纤。

特点：

1. 传输损耗小，中继距离长，远距离传输很经济
2. 抗干扰性能好
3. 无串音干扰保密性好
4. 体积小重量轻，但两段光纤连接需要精密设备



#### 非导引型（无线）

##### 短波通信

短波通信主要靠电离层的反射，电离层不稳定衰落现象和电离层反射的多径效应使质量较差

##### 微波通信

无线电微波频率为300MHz~300GHz，直线传播，可穿透电离层，传播距离受限需要接力。

地面微波接力通信优点：

1. 频率高，频段范围款，所以通信信道容量大
2. 传输质量较高
3. 建设投资少，见效快

地面微波接力通信缺点：

1. 相邻站必须直视
2. 有时候会受到恶劣气候影响
3. 隐蔽性保密性差
4. 大量中继站维护需要人力物力

卫星通信具有较大时延，一般为270ms

ISM频段是免费使用频段5.725GHz~5.825GHz

### 信道复用

发送端使用复用器，信号共享信道通信，接收端使用分用器分离信号

#### 频分复用FDM

所有用户在同样时间占用不同频率带宽资源

用户增多，总带宽变大

#### 时分复用TDM

所有用户在不同时间占用同样频带宽度，更适合数字信号传播

用户增多，时隙宽度减少

STDM：统计时分复用，可以提高信道利用率，每一帧的时隙数少于用户数。按需动态分配时隙，用户有数据的时候才发送给集中器的输入缓存。为了区别不同用户，在每个时隙前有开销。

TDM和STDM帧都是物理层比特流中划分的帧，不是数据链路的帧

#### 波分复用WDM

n路光载波，经调制器将波长变为相隔nm级别的波长上，再经复用器整合，传输，最终到分用器，再分为不同波长，再经过解调器还原

![](./2/WDM.png)

#### 码分复用CDM

特点：各用户挑选不同码型，用户间不造成干扰，且有很强抗干扰能力。

每一个比特时间划分为m个码片，通常为64或128个。

每个站指定m个bit的码片序列，发送1则发送整个序列，发送0则发送序列的反码。因此实际发送的数据提高到原来的m倍，频带宽度也需要扩大到m倍。这种扩频方式称为直接序列扩频(DSSS)，另外一种叫做跳频扩频FHSS。

每一个站的码片序列要正交，即规格化内积$S \bullet T = \frac{1}{m}\sum_{i=1}^mS_iT_i=0$

接收方收到各种信号时，对每个信号用发送方的码片序列进行内积

1. 与其他的信号内积为0
2. 与正确发送方S发出来的码片序列做内积为1
3. 与发送的反码做内积为-1



### 数字传输系统

#### 同步光纤网SONET

同步网络的各级时钟都来自精确地主时钟，为光纤传输定义了同步传输速率等级结构

SONET为基础制定了SDH，SDH与SONET基本速率不同，SDH帧结构以STM-1，更高等级是用N个STM-1复用组成STM-N



### 宽带接入

#### ADSL

非对称数字用户线(Asymmetric Digital Subscriber Line)：用数字技术对现有的模拟通话用户线进行改造。用户线本身信号频率可到1MHz，低频段留给原来的电话使用，高频段留给用户上网使用。ADSL不对称是下行（ISP到用户）带宽大于上行带宽（用户到ISP）

ADSL传输距离取决于数据率、用户线线径、信噪比：用户线越细，传输率越高，信噪比越小，则距离越短。

我国目前方案是离散多音调DMT调制技术，把40kHz~1.1MHz分为子信道，25个用于上行，249个用于下行。使用不同载波进行调制，ADSL启动时调制解调器测试可用频率等情况，选择合适调制方案，不能保证固定传输率，

![](./2/ADSL.png)

ADSL组成：数字用户线接入复用器DSLAM、用户线、用户家中设施。

DSLAM包括ADSL调制解调器（又称为接入端接单元ATU），ATU-C（远端局使用），ATU-R（用户使用） 。用户电话通过电话分离器和ATU-R，经用户线到端局，在通过分离器连到电话交换机

二代ADSL改进：

1. 提高调制效率得到更高数据率
2. 采用无缝速率自适应技术SRA
3. 改善线路质量评测和远程故障定位

#### HFC网

光纤同轴混合网：在目前覆盖面很广的有线电视网基础上开发的居民宽带接入网

光纤从头端连接到光纤结点，光信号转换为电信号，然后通过同轴电缆送到每家。

电缆和电视机之间有机顶盒，机顶盒与PC之间需要电缆调制解调器，一段同轴电缆用户共享传输率，而ADSL用户独享

#### FTTx

光纤到户：光纤进入家门后，才从光信号转换为电信号

光纤干线与用户之间，需要光配线网ODN，无源光配线网称为PON。光线路终端OLT是连接到光纤干线的终端设备，OLT把收到的下行数据发往无源1:N光分路器，然后向所有用户端光网络单元ONU，ONU在哪就是FTT哪，ONU到PC一般使用5类线以太网连接

光配线网采用波分复用，上行下行采用不同波长

PON种类：

1. 以太网无源光网络(EPON)：链路层使用以太网协议
2. 吉比特无源光网络(GPON)：采用通用封装方法GEM



## 第三章 数据链路层

### 点对点信道：一对一

#### 概念

链路：一段连续物理线路（无线或有线）

链路+协议硬件软件=数据链路

#### 主要步骤

1. A把网络层的包添加首部和尾部封装成帧
2. A将帧发给B
3. B验收发现无差错，从帧中提取出包交给网络层，否则丢弃帧

#### 封装成帧

帧的首尾部负责帧定界，且包含控制信息

MTU——数据部分长度上限

SOH(0x01)在最前面表示开始，EOT(0x04)在最后表示结束

#### 透明传输

在数据中出现SOH和EOT时前面加入ESC(0x1B)，进行转义，接收端识别到需要将其删除。方法称为字节填充。

#### 查错检测

##### 比特差错

误码率BER

**循环冗余检验方法CRC**：

1. 把数据划分为组，每组k比特，CRC运算在组后添加n为冗余码，k+n构成帧发送出去。
2. n为冗余码可以用模2运算（加法时不进位，减法转换为加法），在一组M后面加上n个0，除以收发方商定好的n+1位数字P，得出商是Q，余数为R(n位)，余数即为FCS(帧检验序列)，
3. CRC再检验发来的k+n位数字能否整除P，能整除正确，不能为错误。

![](./3/CRC.png)

生成多项式$P(X) = X^3 + X^2 + 1$表示1101

##### 滑动窗口协议

###### 思想

发送一次就确认一次使信道利用率过低，利用率$U=\frac{T_D}{T_D+RTT+T_A}$其中：

1. $T_d$：发送数据帧时间
2. RTT：往返时间
3. $T_A$：发送应答帧时间

允许发送方连续发送多个帧，通过滑动窗口实现流量控制，每个帧有序列号，发送和接收方都需要维护一个序列号的队列

###### 原理

发送方：每当得到一个包，将其组成帧发出，窗口上边界+1；每当窗口下边界的帧被确认时下边界+1

接收方：窗口内序列号代表可以接受的帧。收到帧序列号等于下边界时，接收并上交，返回确认帧，窗口向前移动1个位置。帧序列号落在窗口外就丢弃。

![](./3/滑动窗口.png)

窗口大小都为1的时候即为ARQ协议（发出后接到确认才能继续发送）

###### 错误处理

1. 后退N帧：出错帧后的帧丢弃，从出错帧开始重新发送，实际上错误时接受窗口宽度为1
2. 选择性重传：接收到出错帧时发送一个否定确认NAK。可以让发送方不用等到全体发送完后就重新发送出错数据，接收方要能缓冲窗口内接收到的帧

##### 传输差错

发送三个帧  **[#1]-[#2]-[#3]**

帧丢失：**[#1]-[#3]**

帧重复：**[#1]-[#2]-[#2]-[#3]**

帧失序：**[#1]-[#3]-[#2]**

策略：通信质量好的网络，数据链路层不执行确认重传，由上层如运输层来改正；通信质量差的网络由数据链路层确认重传



### 点对点协议PPP

PPPoE是为宽带上网的主机使用的链路层协议

#### 特点：

用户计算机与ISP通信时的数据链路层协议，特点有：

1. 简单：检验失败直接丢弃，具体操作交给TCP
2. 封装成帧：帧定界
3. 透明性
4. 多种网络层协议：在同一物理链路上支持多种网络层协议
5. 多种类型链路：串并行，同异步，高低速，电or光，静态动态
6. 差错检测
7. 检测连接状态：异常需要报错，链路恢复需要识别，精度为几分钟
8. 最大传送单元：MTU，超过就要丢弃
9. 网络层地址协商：使两个网络层实体协商，配置彼此地址
10. 数据压缩协商：PPP并不要求将数据压缩算法标准化

**PPP不支持多点线路（主站轮流和从站通信），PPP只支持全双工链路**

#### 组成

1. 一个将IP数据报封装到串行链路的方法。PPP支持面向比特的同步链路，也支持异步无奇偶校验8比特数据
2. 一个建立、配置、测试数据链路的控制协议LCP
3. 一套网络控制协议NCP，其中每一个协议支持不同的网络层

#### 帧格式

首尾是标志字段F(0x7E)，连续两帧中间件只需要一个标志字段

信息部分不超过1500字节

| 协议字段 |        协议         |
| :------: | :-----------------: |
|  0x0021  |      IP数据报       |
|  0xC021  | 链路控制协议LCP数据 |
|  0x8021  |   网络层控制数据    |

![](./3/PPP帧格式.png)



#### 字节填充

1. 转义符为0x7D
2. 信息段出现的每一个0x7E转换为(0x7D,0x5E)
3. 信息段出现的每一个0x7D转换为(0x7D,0x5D)
4. 出现小于0x20的控制字符，则需要转义，如0x03变为(0x7D,0x23)

#### 零比特填充

对信息段发送时，连续扫描到5个1就补一位0，保证不会出现6个1，因此没有0x7E。接受时遇到5个1就删除后面的0，可无损恢复。

#### 工作状态



![](./3/PPP协议状态图.png)

##### 配置LCP

物理层建立连接后，发送一个PPP的LCP协议类型帧，可以有三种信息段的一种：

1. 配置确认帧：所有选项都接受
2. 配置否认帧：所有选项都理解但不能接受
3. 配置拒绝帧：有选项无法识别或不能接受，需要协商

网络层协议：根据不同协议交换网络控制分组



### 广播信道：一对多

#### 局域网数据链路

局域网跨越了数据链路层和物理层

###### 信道：

1. 静态划分：代价高，不适合局域网
2. 动态媒体接入控制：多点接入，并非在通信时固定分配给用户有两类：
   1. 随机接入：所有用户随机发送信息，需要解决碰撞的网络协议
   2. 受控接入：有分散控制的令牌环算法，还有集中控制的轮询算法

###### IEEE802.2划分层次

1. 逻辑链路控制LLC(logical link control):现在已经消失了
2. 媒体接入控制MAC(medium access control)

###### 适配器

适配器和局域网之间用电缆或双绞线串行传输，适配器和计算机通过主板I/O并行传输，需要缓存数据。需要安装驱动程序，使适配器知道什么时候把多长数据块发送到局域网或接受。接受发送的时候使用中断通知CPU

#### CSMA/CD协议

发送数据帧的时候在首部写明接收站地址，接收方ROM中存储的硬件地址匹配的时候才会接收。

1. 以太网采用灵活无连接方式，不需编号和确认，为不可靠交付。
2. 以太网发送数据采用曼彻斯特编码

要点：

1. 多点接入：总线型网络
2. 载波监听
3. 碰撞检测：信号电压增大说明出现冲突导致信号叠加

CSMA/CD下以太网只能半双工通信。

以太网使用截断二进制指数算法确定重传时机：

1. 退避时间为争用期$2\tau$,单位为发送1bit所需时间，也可以直接用比特表示
2. 从$[0,1,\dots,(2^k-1)]$中随机取出一个数，记为r。重传推后时间为r倍争用期。k为$Min[重传次数,10]$
3. 重传次数大于16的时候直接丢弃

以太网规定最少帧长为64字节，为了防止碰撞产生的时延内本应叠加的出错帧被识别。

##### 强化碰撞：

一旦发生碰撞，还需要发干扰信号，让所有用户都知道已经发生了碰撞，总共占用时间是A发送到遇到B消息后回来的时间$T_B$+发送强碰撞信号的时间$T_J$+强碰撞信号在内端到端跑的时间$\tau$。

以太网规定帧最小间隔9.6微秒，为了接受的缓存来得及处理

发送过程：

1. 准备发送，获得分组，加上以太网的首尾部，组装成帧放入缓存
2. 检测信道，轮询检测，在最小间隔时间保持空闲则发送，并保留一份在本地
3. 边发送边监听，发送成功回到1，未成功则采用退避算法随机时间发送，再检测



#### 集线器星形拓扑

虽然星型但仍是总线网络，集线器负责收集转发，配备多个接口，一般由少量容错或管理能力。

#### 以太网信道利用率

发送一帧所需要用的平均时间：争用期$n \times 2\tau$、发送数据时间$T_0$、端到端延时$\tau$

定义参数$a=\frac{\tau}{T_0}$，让其尽可能小，若做到无争用期，极限信道利用率为$\frac{1}{1+a}$

#### 以太网MAC层

##### 硬件地址

MAC地址（硬件地址），固定在适配器ROM中的48位全球地址，

生产时高24位为OUI，IEEE规定地址第一字节最低位为I/G位，0表示单站地址，1位组地址。第一字节倒数第二位为G/L位，为0是全球管理，为1是本地管理

单播：一对一，收到的地址与本MAC地址相同

广播：一对全体，发送给局域网所有站点，全1地址

多播：一对多，发送给部分站点



##### MAC帧格式



![](./3/MAC帧格式.png)

| 类型字段 |   协议   |
| :------: | :------: |
|  0x0800  | IP数据报 |
|  0x8137  |   IPX    |

发送方把一个帧发送完后，不发其他码元，电压不变化。采用曼彻斯特编码很容易找到结束位置，根据位置反推4字节可以找到结束的数据段位置。

IP层首段标记总长度，用总长度减去当前接受的数据段长度，得到填充长度，从尾部舍弃这些即可

插入在前的是为了让适配器时钟与比特流同步，最后字节的11位定界符，代表数据到来。

FCS检验范围不包括前面插入的8字节

无效帧：

1. 帧的长度不是整数个字节
2. 用FCS校验出查错
3. 数据段长度不在46~1500

IEEE802.3规定类型字段大于0x0600，表示协议类型，小于0x0600默认为LLC帧，表示数据段长度





### 扩展的以太网

#### 物理拓展

使用光纤拓展主机和集线器之间的距离，用主干集线器把各个系以太网连起来，形成更大的一个碰撞域，任意时刻只有一个站在发送数据。多个系统之间若适配器吞吐量不同，则连在一起工作，吞吐量为最低吞吐量。

#### 数据链路层拓展

##### 交换式集线器（以太网交换机）特点：

1. 多接口网桥
2. 直接与主机或以太网相连，工作在全双工状态，并行发送
3. 连入的主机独占传输媒体，无碰撞传输数据
4. 有存储器进行缓存
5. 即插即拔，用硬件转发，内部帧交换表通过自学习算法建立

##### 自学习功能：

发送数据时将MAC地址和接口写入，别的数据如果要发送给某个MAC地址，现在表中查找，如果有对应地址直接发送，没有则广播。设置失效时间过期被删除。核心思想：A从1接口发出数据，A接收数据也先从A口接收。

生成树协议STP：一台主机到其他主机路径是无环路树状结构

##### 星型以太网

全双工，但是帧结构还是以太网的帧结构

#### 虚拟局域网

VLAN:由一些局域网网段构成的与物理位置无关的逻辑组，且这些网段有同样的需求。每一个VLAN帧会标记该发往哪个VLAN

![](./3/VLAN.png)

0x8100为802.1Q类型标记，CFI为规范格式指示符，最后是VLAN标识符



![](./3/8021Q.png)

#### 高速以太网

传输速率上升，帧发送时间变短，为了让参数a更小($a=\frac{\tau}{T_0}$)，只能减小$\tau$。减小$\tau$要么剪短网段距离，要么增大争用的时候发送的字节

载波延伸：最短帧长64，增大争用期，MAC帧需要补足到512字节

10GE比特网只在全双工模式运行，不存在争用期



## 第四章 网络层

### 两种思路：

1. 面向连接的方式，建立虚电路，所有分组都从固定路径中发送到明确地址，提供可靠传输
2. 向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。包在网络中由不同途径到达，不提供可靠传输，网络层上层保证可靠性。

|      对比方面      |               虚电路服务               |              数据报服务              |
| :----------------: | :------------------------------------: | :----------------------------------: |
|        思路        |           可靠通信由网络保证           |          可靠通信由主机保证          |
|      连接建立      |                 必须有                 |                不需要                |
|      终点地址      | 仅在连接建立阶段用，每个分组用虚电路号 |       每个分组都有完整终点地址       |
|      分组转发      |      同一虚电路分组按同一路由转发      |       每个分组独立选择路由转发       |
|      结点故障      |    所有通过故障结点虚电路都不能工作    | 故障结点丢失分组，一些路由可能会变化 |
|      分组顺序      |          总按发送顺序到达终点          |             不一定按顺序             |
| 差错处理和流量控制 |       可由网络负责也可由主机负责       |           只能用户主机负责           |



### 网际协议IP

#### 虚拟互联网络

强调逻辑网络，使性能各异的网络连起来看起来像是一个网络，屏蔽了下层的异构细节，用户用虚拟互联可认为所有计算机接入的是一个网络

#### 分类的IP地址及表示方法

IP地址划分为若干类，第一个字段网络号，第二个主机号，网络号在整个网络里面唯一，主机号他的网络范围内要唯一。

![](./4/IP网络主机.png)

A、B、C类地址都是单播地址，前面1~3位为类别位

D类地址为多播

E类地址考虑以后用

**IP地址用点分十进制记法**

#### 常用三类IP地址

##### A类：

网络号1个字节，第一位固定为0，可指派号是$2^7-2$个，全0表示“本网络”，127作为本地软件的环回测试地址。

主机号占3个字节，最大主机数$2^{24}-2$个，全0主机号表示该IP地址是"本主机"所连接到的单个网络地址，全1主机号表示该网络上的所有主机

##### B类：

地址128.0.0.0不指派，可以指派的B类最小网络地址是128.1.0.0。因此B类地址可指派的网络数为$2^{14}-1$，主机$2^{16}-2$。

##### C类：

地址192.0.0.0不指派，可以指派的C类最小网络地址是192.0.1.0 ，因此C类地址可指派的网络总数是$2^{21}-1$，每一个C类地址的最大主机数是$2^8-2$。

| 网络号 |       主机号       | 源地址 | 目的地址使用 |                 代表意思                 |
| :----: | :----------------: | :----: | :----------: | :--------------------------------------: |
|   0    |         0          |  可以  |     不可     |             在本网络上本主机             |
|   0    |      host-id       |  可以  |     不可     |        在本网络上某台主机host-id         |
|  全1   |        全1         |  不可  |     可以     | 只在本网络进行广播（各路由器均不可转发） |
| net-id |        全1         |  不可  |     可以     |        对net-id上所有主机进行广播        |
|  127   | 非全0或全1的任何数 |  可以  |     可以     |           用于本地软件环回测试           |



##### 特点：

1. 网络和主机分开，路由器只需要记住网络号，缩小了占用内存和查找时间
2. 联入两个网络的需要两个IP地址，比如路由器
3. 转发器和网桥连接的若干局域网还是同一个网络，具有同样的网络号
4. 所有网络平等

表示一个局域网的网络号：可以直接将主机号变为0再加网络号变成IP地址

无编号网络（无名网络）：两个路由器直接相连的时候可以不分配IP地址，来节省IP资源

![](./4/IP地址.png)

#### IP地址与硬件地址

1. IP层及以上抽象的互联网上只能看到IP地址，数据报里只有目的IP和源IP地址
2. 路由器只根据目的站IP地址网络号进行选择
3. 局域网链路层只能看见MAC帧，每一次转发都有丢掉之前帧的目的物理地址和源物理地址，然后添加新的地址字段
4. IP层抽象互联网屏蔽下层很复杂的细节，网络层上只考虑用统一IP地址表示主机和主机的通信
5. 每个路由器（连接两个网络）有两个IP地址，两个物理地址



#### 地址解析协议ARP

##### 作用&特点

已知一个主机IP地址，找到它的物理地址

每台主机都有一个**ARP Cache**，里面有**本局域网**的各主机和各路由IP地址到物理地址映射表。



##### 查找方法

1. 主机A在本局域网广播发送ARP请求，内容为本IP，本物理地址，查询目标IP地址
2. 所有主机运行的ARP进程都收到请求
3. 主机B发现与查询目标IP地址一致，收下请求，将A的IP地址和物理地址写入ARP Cache
4. 对A发送ARP响应（单播），内容为B硬件地址
5. A将B的IP地址和物理地址写入ARP Cache

Cache中信息需要设置生存时间，超时就删除

![](./4/ARP.png)

##### 典型情况

1. 发送方和接收方都是同一局域网主机，直接广播ARP分组，找到目标的物理地址
2. 发送方是主机，接收方为不同局域网的主机，广播找到一个路由器R1的硬件地址，交给R1处理
3. 发送方式路由器，接收方为同一局域网主机，在主机所在局域网中广播找到目标主机物理地址
4. 发送方是路由器，接收方为不同局域网主机，在不同局域网上广播找到路由器R2硬件地址，交给R2处理

#### IP数据报格式

![](./4/IP数据报.png)

##### 首部固定部分

1. 版本：4位，IP协议的版本，ipv4 or ipv6

2. 首部长度：4位，范围为5~15，单位是32位字长=4字节。当 IP 分组的首部长度不是4字节的整数倍时，必须利用最后的填充字段加以填充

3. 区分服务：8位，用来获得更好的服务，只有使用区分服务时起作用，一般的情况下不使用

4. 总长度：16位，指首部和数据之和的长度，单位为字节。因此数据报最大长度为$2^6-1=65535$字节
   1. 数据链路层规定数据帧的数据字段最大传送单元 MTU，IP数据报封装成链路层帧时，数据报的总长度不能超过MTU 值，若超过必须分片处理。
   2. 每一个IP 数据报越短，路由器转发的速度就越快。IP 协议规定，互联网中所有主机和路由器，必须能够接受长度不超过 $60+512+4$字节的数据报（4为富余量），否则就要进行分片。
   3. 在进行分片时，数据报首部中的"总长度"字段是指分片后的每一个分片的首部长度与该分片的数据长度的总和。
   
5. 标识：16位。IP 软件在存储器中维持一个计数器，每产生一个数据报，计数器就加 1，并将此值赋给标识字段。相同的标识字段的值使分片后的各数据报片最后能正确地重装成为原来的数据报

6. 标志：3位，目前只有两位有意义：

      1. 标志字段中的最低位记为MF(More Fragment)，MF=1表示后面还有分片，MF=0表示若干片中的最后一个
      2. 标志字段中间的一位记为DF(Don't Fragment)，表示不能分片，只有当 DF=0时才允许分片

7. 片偏移：13位，分片后某片在原分组中的相对位置。单位为8个字节长，这意味着每个分片的长度一定是8字节的整数倍
      ![](./4/数据报分片.png)
      
8. 生存时间(TTL)：8位，最大数值是255，表明数据报在网络中寿命。由发出数据报的源点设置这个字段，防止无法交付的数据报无限制地在互联网中兜圈子。每经过一个路由器，就把 TTL 减去一定数值，当TTL 值减为零时，就丢弃这个数据报

      1. 最初单位为秒，减去的为在路由消耗时间，小于1秒的记为1秒
      2. 现在 TTL 的单位不再是秒，而是跳数，每次减去的为1，意义是指明数据报在互联网中至多可经过多少个路由器

9. 协议：8位，使目的主机IP层知道应上交给哪个协议

      | 协议名 | ICMP | IGMP |  IP  | TCP  | EGP  | IGP  | UDP  | IPv6 | ESP  | OSPF |
      | :----: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
      | 字段值 |  1   |  2   |  4   |  6   |  8   |  9   |  17  |  41  |  50  |  89  |
其中IP指IP数据报封装到IP数据报中

10. 首部校验和：16位。这个字段只检验数据报的首部，但不包括数据部分。数据报每经过路由器，路由器都要重新计算一下首部检验和。计算方法∶ 
    
    1. 在发送方，先把 IP 数据报首部划分为许多 16 位字的序列，并把检验和字段置零。用反码算术运算把所有 16 位字相加后，将得到的和的反码**（按位取反）**写入检验和字段
    2. 接收方收到数据报后，将首部的所有 16 位字再使用反码算术运算**（循环进位）**相加一次。将得到的和取反码**（按位取反）**，即得出接收方检验和的计算结果。若首部未发生任何变化，则此结果必为0，于是就保留这个数据报。否则即认为出差错，并将此数据报丢弃。

![](./4/首部校验和.png)

11. 源地址

12. 目的地址

##### 首部可变部分

可选字段用来支持排错、测量以及安全等措施，长度为1到 40 个字节，这些选项很少被使用



#### IP 层转发分组的流程

只研究一个路由器转发到另一个路由器，路由表每一行对应一个网络

对每一条路由最主要的是以下两个信息∶ （目的网络地址，下一跳地址） 

##### 特定主机路由

对特定的目的主机而不是所在网络指明一个路由，使管理人员更方便控制、测试，或为了考虑安全问题

##### 默认路由

查找不到目标网络就自动使用默认路由，可以减小路由表所占用的空间和搜索路由表所用的时间，在一个网络只有很少的对外连接时很有用，路由表中默认路由的目标地址常记为0.0.0.0

##### 分组转发算法

1. 从数据报的首部提取目的主机的IP地址D，得出目的网络地址为N。
2. 若N就是与此路由器直接相连的某个网络地址，则直接把目的主机地址D转换为具体的硬件地址，把数据报封装为 MAC 帧，再发送此帧给目的主机；否则就是间接交付执行3
3. 若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则执行4
4. 若路由表中有到达网络N的路由，则把数据报传送给路由表中所指明的下一跳路由器；否则执行5
5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则执行6
6. 报告转发分组出错



### 划分子网

#### 三级IP

##### 优点

1. 比两级地址空间利用率高，两级的主机地址用不满，三级可分配
2. 两级地址给每个物理网络分配号码，如果一个路由连接过多网络，路由表开销太大，三级网络数不会太大
3. 两级IP地址不够灵活，三级可随时增加本单位的网络

##### 划分

1. 划分子网属于单位内部事情，本单位以外网络看不到其是由多少个子网组成的，本单位对外仍表现为一个网络
2. 划分子网的方法是从网络的主机号借用若干位作为子网号，$IP地址 ∶∶={ <网络号>，<子网号>， <主机号>}$
3. 其他网络发送给本单位某台主机的IP数据报，仍然根据IP数据报的目的网络号找到连接在本单位网络上的路由器。但此路由器在收到IP数据报后，再按目的网络号和子网号找到目的子网，把IP数据报交付目的主机

![](./4/子网划分.png)

#### 子网掩码

虽然没有特别规定，但是一般都采用一串连续的1，代表取IP地址的前多少位为子网地址。只需要地址与掩码进行与运算，路由器就能知道应该转发到哪个网络

任何路由器都要使用子网掩码，如果不划分子网，采用默认子网掩码（2级IP地址）

路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。在路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码。

互联网标准协议规定子网号不能为全1或全0，但随着CIDR使用，现在也能用了。。。。。

#### 子网分组转发

##### 路由表内容：

1. 目的网络地址
2. 子网掩码
3. 下一跳地址

##### 算法

1. 从收到的数据报的首部提取目的IP地址D。
2. 对路由器直接相连的网络逐个进行检查∶用各网络的子网掩码和 D 逐位相与，看结果是否和相应的网络地址匹配。若匹配，则把分组进行直接交付（当然还需要把D转换成物理地址，把数据报封装成帧发送出去），转发任务结束。否则执行3
3. 若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则执行4。
4. 对路由表中的每一行，用其中的子网掩码和D逐位相与，其结果为N。若N与该行的目的网络地址匹配，则把数据报传送给该行指明的下一跳路由器；否则执行5。
5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行6。
6. 报告转发分组出错。



### 构造超网

##### 无分类路由选择CIDR

###### 定义

$IP地址 ∶∶={ <网络前缀>，<主机号>}$

使用斜线计法，网络地址xxx.xxx.xxx.xxx/n，n代表前缀所占位数

###### 划分

网络前缀都相同的连续的IP地址称为CIDR地址块，知道任何一个地址，就能知道其所属块的最小地址和最大地址（主机号全0和全1），实际中一般不使用最大最小地址

CIDR的地址掩码可以看做子网掩码，前缀长度为n，则掩码为n个1后(32-n)个0

###### 优点

分配更灵活，主机个数的种类更多

地址聚合，采用CIDR，原本在路由器中的多个项目变成一个项目就能找到该超网，然后再进行转发，简化了路由表查找



##### 最长前缀匹配

CIDR中每个路由器的项目由网络前缀和下一跳地址组成。匹配符合的时候优先选择具有最长网络前缀路由。



##### 二叉线索查找路由表

![](./4/二叉线索.png)

###### 普通的IP搜索 

从根到叶节点的路径代表了路由表中存放的地址

先找出每一个IP对应的唯一前缀，用其构造二叉线索树

查找时按照路径查找，如果没有查找到叶节点则未找到

###### 根据网络前缀匹配

要将二叉线索用于路由表中，必须使二叉线索中的每一个叶节点包含所对应的网络前缀和子网掩码。当搜索到一个叶节点时，就必须将寻找匹配的目的地址和该叶节点的子网掩码进行与运算，看结果是否与对应的网络前缀相匹配。



### 网际控制报文协议ICMP

![](./4/ICMP格式.png)

#### 报文种类

1. ICMP差错报告报文
2. ICMP询问报文

| ICMP报文种类 | 类型值 |   ICMP报文类型   |
| :----------: | :----: | :--------------: |
|   差错报告   |   3    |    终点不可达    |
|   差错报告   |   11   |     时间超过     |
|   差错报告   |   12   |     参数问题     |
|   差错报告   |   5    |     改变路由     |
|   询问报文   |  8或0  |  回送请求或回答  |
|   询问报文   | 13或14 | 时间戳请求或回答 |

##### ICMP差错报告

所有ICMP差错报告报文数据字段都有同样的格式：

![](./4/ICMP差错报告数据.png)

IP数据报数据字段前8字节有运输层端口信息，以及运输层报文发送序号

不应发送差错报告的情况：

1. 对 ICMP 差错报告报文，不再发送 ICMP 差错报告报文
2. 对第一个分片的数据报片的所有后续数据报片，都不发送 ICMP 差错报告报文
3. 对具有多播地址的数据报，都不发送 ICMP 差错报告报文
4. 对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报，不发送ICMP 差错报告报文。



##### ICMP询问报文

1. 回送请求和回答 ICMP 回送请求报文是由主机或路由器向一个特定的目的主机发出的询问。收到此报文的主机必须给源主机或路由器发送 ICMP 回送回答报文。这种询问报文用来测试目的站是否可达以及了解其有关状态。
2. 时间戳请求和回答ICMP 时间戳请求报文是请某台主机或路由器回答当前的日期和时间。在 ICMP 时间戳回答报文中有一个32 位的字段，其中写入的整数代表从 1900 年 1月1 日起到当前时刻一共有多少秒。时间戳请求与回答可用于时钟同步和时间测量。



#### ICMP应用

##### PING

用来测试两主机间的连通性，使用ICMP回送请求与回答报文，从应用层跳过TCP和UDP直接使用IP层

##### Traceroute

用来跟踪包从源点到终点的路径。

从源主机向目的主机发送一连串IP数据报，封装无法交付的UDP用户数据报。

1. 第一个数据报$P_1$的TTL设置为1，当到达路径上的第一个路由器$R_1$时，由于收下后TTL为0，被丢弃并向源主机发送一个 ICMP 时间超过差错报告报文
2. 源主机接着发送第二个数据报$P_2$，并把TTL设置为2，这样一直继续下去
3. 当最后一个数据报刚刚到达目的主机时，因其是无法交付的UDP用户数据报，因此目的主机要向源主机发送 ICMP 终点不可达差错报告报文

所有返回的ICMP报文给出了路由信息——到达目的主机所经过路由器IP地址，以及到达其中每一个路由器往返时间




### 路由选择

#### 基本概念

##### 理想路由算法

1. 算法必须是正确完整：正确是∶ 分组一定能够最终到达目的网络和目的主机
2. 算法在计算上应简单
3. 算法应能适应通信量和网络拓扑的变化
4. 算法应具有稳定性：网络通信量和网络拓扑相对稳定时，应收敛于一个可以接受的解
5. 算法应是公平的
6. 算法应是最佳的：使分组平均时延最小而网络吞吐量最大（没有可靠性重要）



##### 分层次路由选择协议

自治系统AS：单一技术管理下一组路由器，用内部自治的路由选择协议和共同的度量，对其他AS表现出—致的路由选择策略

协议有两类：

1. 内部网关协议(IGP)：AS间叫域间路由选择
2. 外部网关协议(EGP)：AS内叫域内路由选择



#### 内部网关协议RIP

##### 工作原理

一种分布式的基于距离向量的路由选择协议，是互联网的标准协议，最大优点是简单

RIP协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录，使得从每一个路由器到每一个目的网络的路由都是最短的，所有路由器最终拥有到系统中每个节点的路由信息

距离定义∶

1. 从一路由器到直接连接的网络的距离定义为1
2. 从一路由器到非直接连接的网络的距离定义为所经过的路由器数加1
3. RIP允许一条路径最多只能包含15个路由器，16相当于不可达，可见只适用于小型互联网

特点：

1. 仅和相邻路由器交换信息
2. 路由器交换的信息是当前本路由器所知道的全部信息，即自己现在的路由表
3. 按固定的时间间隔交换路由信息
   

##### 距离向量算法

###### 核心思想：
设X是结点A到B最短路径上一结点，若拆成两段路径A$\rightarrow$X和X$\rightarrow$B，则每一段路径分别是A到X和X到B的最短路径。

###### 步骤：

1. 对地址为X的相邻路由器发来的RIP报文，先修改此报文中的所有项目：把下一跳字段中地址改为X，把距离加1
2. 对修改后的 RIP 报文中的每一个项目，若原来的路由表中没有目的网络N，则把该项目添加到路由表中；否则执行3
3. 若下一跳路由器地址是X，则把收到的项目替换原路由表中的项目（网络结构更新）；否则执行4
4. 若收到项目中距离d小于路由表中距离则进行更新；否则什么也不做
5. 若3分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达的路由器
6. 返回




##### RIP协议报文格式

![](./4/RIP2格式.png)

RIP 协议使用运输层的用户数据报 UDP 进行传送，使用 UDP 的端口 520

###### 首部：

命令字段：

1. 为1表示请求路由信息
2. 为2表示对请求路由信息的响应或未被请求而发出的路由更新报文

为4字节字对齐后面补0

###### 路由部分：

每个路由信息20个字节：

1. 地址族标识符用来标志所使用的地址协议，2代表用IP地址

2. 路由标记填入自治系统号ASN（IANA分配）
3. 网络地址
4. 该网络的子网掩码
5. 下一跳路由器地址
6. 网络距离。

###### 鉴别功能：

占用第一个路由信息的地址族标识符置为全1，路由标记写入鉴别类型，剩下的 16 字节为鉴别数据。



##### 存在问题

当网络出现故障时，要经过比较长的时间才能将此信息传送到所有的路由器，收敛速度慢，好消息传播得快，而坏消息传播得慢。



#### 内部网关协议OSPF

##### OSPF基本特点

OSPF：开放最短路径优先

1. 使用分布式链路状态协议，每个路由器用链路状态数据库记录全网拓扑结构
2. OSPF允许管理员给每条路由指派不同的代价
3. 如果到同一个目的网络有多条相同代价的路径，可以将通信量分配给几条路径，达到负载平衡
4. 所有OSPF路由器间交换的分组都具有鉴别的功能，保证仅在可信赖路由器间交换链路状态信息
5. OSPF支持可变长度的子网划分和无分类的编址CIDR
6. OSPF让每一个链路状态都带上一个32位的序号，序号越大状态就越新

###### 与RIP不同点：

1. 使用的方法是洪泛法向本自治系统中所有路由器发送信息
2. 发送的信息：是与本路由器相邻的所有路由器的链路状态
   链路状态：本路由器和哪些路由器相邻，以及该链路的度量
3. 只有链路状态变化时，路由器才向所有路由器发送信息

##### 概念

![](./4/OSPF区域.png)

###### 区域：

区域内部路由器只知道本区域网络拓扑，不知道其他区域情况。

1. 主干区域标识符规定为 0.0.0.0，用来连通其他下层区域
   1. 主干区域内路由器叫主干路由器
   2. 和本自治系统外交换路由信息的叫做自治系统边界路由器
2. 其他区域：区域边界路由器对其他区域信息进行概括



##### OSPF数据格式

**OSPF不用UDP，直接用IP数据报**

![](./4/OSPF格式.png)



1. 版本：当前的版本号是2
2. 类型：五种类型分组中的一种
3. 分组长度：包括OSPF首部在内的分组长度，以字节为单位
4. 路由器标识符：标志发送该分组的路由器的接口的IP地址
5. 区域标识符：分组属于的区域的标识符
6. 检验和：用来检测分组中的差错
7. 鉴别类型：0代表不用，1代表口令
8. 鉴别：鉴别类型为0时就填入0，鉴别类型为1则填入8个字符的口令

##### 五种分组类型

1. 问候(Hello)：用来发现和维持邻站的可达性
2. 数据库描述(Database Description)：向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息
3. 链路状态请求(Link State Request)：向对方请求发送某些链路状态项目的详细信息
4. 链路状态更新(Link State Update)：用洪泛法对全网更新链路状态，路由器将其链路状态通知给邻站
5. 链路状态确认(Link State Acknowledgment)：对链路更新分组的确认

##### 方法

1. 路由器刚开始工作，通过问候分组得知它有哪些相邻路由器，以及向它们发送的代价
2. 和相邻路由器交换本数据库中已有的链路状态摘要信息（有哪些路由器信息及序号写入数据库）
3. 使用链路状态请求，向对方请求发送自己所缺少的某些链路状态项目的详细信息
4. 通过一系列状态更新，建立全网同步的链路数据库
5. 采用可靠洪泛法，需要更新后发送确认（重复更新不需要）

对多点接入的局域网采用指定路由器代表所有链路向各路由器发送状态信息，减少广播信息量



#### 外部网关协议BGP

##### 概念

BGP：边界网关协议

BGP采用路径向量的路由选择协议

##### BGP speaker

1. 一般选定一个路由器为speaker，每一个AS的管理员至少选一个BGP speaker

2. BGP speaker要交换路由信息，需先建立TCP连接(端口号为179)，然后在此连接上交换BGP报文，这两个speaker彼此成为对方的邻站或对等站
3. 除了运行BGP协议还需要运行OSPF和RIP
4. 支持CIDR，路由表中交换的信息应包括目的网络前缀、下一跳路由器、到达该目的网络所要经过的自治系统序列
5. 根据最终的信息，speaker可以自己算出到各自治系统的路由，最终导出为一个连通的树（无环）
6. BGP刚运行时和邻站交换整个路由表，之后有变化才更新

##### 报文类型&格式

1. OPEN报文：用来与相邻的另一个BGP发言人建立关系，使通信初始化
   1. 版本：1 字节，现在的值是4
   2. 本自治系统号：2字节，使用全球唯一的16位自治系统号，由ICANN地区登记机构分配
   3. 保持时间：2字节，以秒计算的保持为邻站关系的时间
   4. BGP标识符：4字节，通常就是该路由器的IP地址
   5. 可选参数长度：1字节
   6. 可选参数
2. UPDATE报文：用来通告某一路由的信息，以及列出要撤销的多条路由
   1. 不可行路由长度：2字节，指明下一个字段的长度
   2. 撤销的路由：列出所有要撤销的路由
   3. 路径属性总长度：2 字节，指明下一个字段的长度
   4. 路径属性：定义在这个报文中增加的路径的属性
   5. 网络层可达性信息NLRI：定义发出此报文的网络，包括网络前缀位数、IP地址前缀
3. KEEPALIVE报文：用来周期性地证实邻站的连通性，只有BGP的通用首部
4. NOTIFICATION报文：用来发送检测到的差错
   1. 差错代码：1字节
   2. 差错子代码：1字节
   3. 差错数据：给出有关差错的诊断信息

![](./4/BGP格式.png)

通用首部：

1. 标记字段：16字节长，用来鉴别收到的BGP报文，不使用鉴别时置为全1
2. 长度字段：2字节长，包括通用首部在内的整个BGP报文以字节为单位的长度，范围在19~4096
3. 类型字段：1字节长，值为1到4，分别对应四种BGP报文



##### 交换过程

1. 一开始向邻站进行商谈时就必须发送OPEN报文，如果邻站接受这种邻站关系，就用KEEPALIVE报文响应
2. 为此，这两个BGP speaker彼此要周期性地交换KEEPALIVE报文（一般每隔 30 秒）
3. 可以用UPDATE报文撤销以前通知过的路由，也可以增加新路由，一次可以撤销许多条，但只能增加一条



### 路由器

#### 路由器结构

![](./4/路由器结构.png)

##### 路由选择部分

核心构件是路由选择处理机：根据所选定的路由选择协议构造出路由表，同时经常或定期和相邻路由器交换路由信息，不断地更新和维护路由表

##### 分组转发部分

它由三部分组成∶交换结构、一组输入端口和一组输出端口（硬件接口）

1. 交换结构：根据转发表对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去
2. 输入端口&输出端口：分为物理、数据链路、网络层三层



##### 需要注意的：

转发：

1. 任务：把收到的IP数据报从路由器合适的端口转发出去，仅仅涉及到一个路由器
2. 转发表：从路由表得出，转发表每一行必须包含从要到达的目的网络到输出端口和某些MAC地址信息（如下一跳的以太网地址）的映射
3. 数据结构：转发表的结构应当使查找过程最优化，转发表则甚至可用特殊的硬件来实现

路由选择：

1. 任务：按照复杂的路由算法，得出整个网络的拓扑变化情况，因而能够动态地改变所选择的路由，并由此构造出整个的路由表，涉及到很多路由器
2. 路由表：路由表一般仅包含从目的网络到下一跳（用 IP 地址表示）的映射
3. 数据结构：路由表则需要对网络拓扑变化的计算最优化，路由表总是用软件实现的  


线速：输入端口处理速率等于分组传送到路由器的速率，一个2.5Gbit/s的链路，分组长度256字节，线速大于1Mpps（百万分组/秒）



##### 工作方式

1. 输入端口
   1. 物理层进行比特的接收
   2. 数据链路层则按照链路层协议接收传送分组的帧，对帧首尾进行剥去
   3. 网络层中，当一个分组在查表，紧跟着收到另一个分组，必须在队列中排队等待，产生一定时延
2. 送入交换结构
   1. 若为路由器间交换信息分组（如RIP或OSPF分组等），则把其送交路由器的路由选择部分中的路由选择处理机
   2. 若为数据分组，则按照分组首部中的目的地址查找转发表
      复制的转发表放在每一个输入端口中，路由选择处理机负责对各转发表的副本进行更新，可以避免在路由器中的某一点上出现瓶颈
3. 输出端口
      1. 网络层中设有一个缓冲区，当交换结构传送过来的分组的速率超过输出链路的发送速率时，存入来不及发送的分组
      2. 数据链路层处理模块把分组加上链路层的首部和尾部
      3. 物理层发送到外部线路



##### 交换方法

![](./4/交换方法.png)

1. 最早路由器利用计算机CPU作为路由选择处理机：
   1. 输入输出端口相当于I/O设备，收到分组时用中断方式通知路由选择处理机
   2. 分组就从输入端口复制到存储器中
   3. 路由器处理机从分组首部提取目的地址，查找路由表，再将分组复制到合适的输出端口缓存中，交换速率不大于读或写速度的一半
2. 通过存储器进行交换：目的地址的查找和分组在存储器中缓存都在输入端口进行
3. 通过总线进行交换：数据报从输入端口通过共享总线直传到输出端口，不需要路由选择处理机干预。但是由于总线共享，因此同一时间只有一个分组在总线上传送，若发现总线忙则在输入端口排队等待，路由器转发速率不高于总线速率
4. 通过纵横交换结构进行交换：有2N条总线，使N个输入端口和N个输出端口相连接，交叉结点使水平或垂直总线接通断开，决定了转发到哪个端口
   1. 当输入端口收到一个分组时，就将它发送到与该输入端口相连的水平总线上
   2. 若转发输出端口垂直总线空闲，则垂直总线与水平总线接通
   3. 若垂直总线被占用，则后到达的分组就被阻塞，必须在输入端口排队



### IPv6

#### IPv6变化

##### 整体变化：

1. 更大的地址空间：从32增大到128
2. 扩展的地址层次结构：IPv6 由于地址空间很大，因此可以划分为更多的层次
3. 灵活的首部格式：定义了许多可选的扩展首部，提供更多功能，提高路由器效率，路由器对扩展首部不进行处理（除逐跳扩展首部外）
4. 改进的选项：允许数据报包含有选项的控制信息，因而可以包含一些新的选项，放在有效载荷中
5. 允许协议继续扩充
6. 支持自动配置：不需要使用DHCP
7. 支持资源的预分配：支持实时视像等要求保证一定的带宽和时延的应用
8. 

##### 字段变化

1. 首部4字节对齐改为8字节对齐
2. 首部长度不定长变为固定40字节
3. 取消了服务类型字段，因为优先级和流标号字段实现了服务类型字段的功能
4. 取消了总长度字段，改用有效载荷长度字段
5. 取消了标识、标志和片偏移字段，因为这些功能已包含在分片扩展首部中
6. TTL字段改称跳数限制字段
7. 取消了协议字段，改用下一个首部字段
8. 取消了检验和字段，这样就加快了路由器处理数据报的速度（运输和数据链路都有检验）
9. 取消了选项字段，而用扩展首部来实现选项功能

#### IPv6组成

![](./4/IPv6格式.png)

##### 基本首部

1. 版本：4bit，指明协议版本
2. 通信量类：8bit，区分不同的IPv6数据报类别或优先级
3. 流标号：20bit，IPv6允许路由器把每一个数据报与一个给定的资源分配相联系
   1. 流概念：从特定源点到特定终点（单播或多播）的一系列数据报（如实时音频或视频传输），同一个流的数据报都具有同样的流标号，可保持质量
   2. 传统电子邮件或非实时数据，流标号则没有用处，把它置为0
4. 有效载荷长度：16bit，指明除基本首部以外的字节数，最大值是65535
5. 下一个首部：8bit
   1. 没有扩展首部时，指出基本首部后面的数据应交付 IP 层上面的哪一个高层协议（TCP为6，UDP为17）
   2. 有扩展首部时，标识后面第一个扩展首部的类型
6. 跳数限制：8bit，用来防止数据报在网络中无限期地存在，最大值255，过一个路由器减1
7. 源地址：128bit，发送端IP地址
8. 目的地址：128bit，接收端IP地址

##### 有效载荷

###### 拓展首部

允许有零个或多个扩展首部，种类为∶

1. 逐跳选项
2. 路由选择
3. 分片
4. 鉴别
5. 封装安全有效载荷
6. 目的站选项。

扩展首部由若干个字段组成，长度不同，但第一个字段都是8位的下一个首部字段，有多个扩展首部时，应按以上先后顺序出现  

###### 数据部分

放在拓展首部之后



#### IPv6地址

##### 基本类型地址

1. 单播（unicast）：点对点通信。
2. 多播（multicast）：一点对多点的通信，发送每一个地址
3. 任播（anycast） ：一点对多点，但数据报只交付其中的一个，通常是距离最近的一个

主机和路由器均称为结点，一个结点可能有多个与链路相连的接口，每一个接口指派一个IP地址，因此一个结点可以有多个单播地址，均可当作目的地址

##### 记法

冒号十六进制： `68E6:8C64:FFFF:FFFF:0:1180:960A:FFFF`

允许使用零压缩：`FF05:0:0:0:0:0:0:B3`$\rightarrow$`FF05::B3`，`0:0:0:0:0:0:0:0`$\rightarrow$`::`，地址中只能使用一次零压缩

与IPv4混合记法：`0:0:0:0:0:0:128.10.2.1`或`::128.12.2.1`

CIDR斜线法：`12AB::CD30:0:0:0:0/60`

##### 地址分类

|     地址类型     |             二进制前缀              | 源地址 | 目的地址 |
| :--------------: | :---------------------------------: | :----: | :------: |
|    未指明地址    |  0000.....0（128位），可记为::/128  |  可以  |   不可   |
|     环回地址     | 0000......1（128位），可记为::1/128 |  可以  |   可以   |
|     多播地址     |   11111111（8位），可记为FF00::/8   |  不可  |   可以   |
| 本地链路单播地址 | 1111111010（10位），可记为FE80::/10 |        |          |
|   全球单播地址   |                其他                 |  可以  |   可以   |

1. 未指明地址：这个地址不能用作目的地址，只能当作某主机源地址使用，条件是这台主机还没有配置到一个标准的 IP 地址
2. 环回地址：IPv4的环回地址一样
3. 多播地址：发送多播信息
4. 本地链路单播地址：使用TCP/IP协议但没连接到互联网上，可以这种本地地址通信，但不能和互联网上的其他主机通信
5. 全球单播地址：这一类单播地址使用得最多，可用多种方法进行划分
   ![](./4/IPv6划分方法.png)



#### IPv4到IPv6过渡

一部分主机（或路由器）装有双协议栈∶一个IPv4和一个IPv6，记为IPv6/IPv4，具有IPv4和IPv6地址，因此与IPv6和IPv4系统都能通信

##### 双协议栈工作原理：

1. 用域名系统DNS来查询目的主机是IPv4还是IPv6地址
2. 若IPv6转IPv4，把IPv6数据报首部转换为IPv4数据报首部后发送
3. 若IPv4转IPv6，恢复原来的IPv6数据报，首部中的某些字段无法恢复，例如流标号只能变为空缺

![](./4/双协议栈.png)

##### 隧道技术工作原理

1. 用域名系统DNS来查询目的主机是IPv4还是IPv6地址
2. 若IPv6转IPv4，把IPv6数据报封装放入IPv4数据报数据部分，把IPv4首部的协议字段的值设置为41，目的地址和源地址设置为隧道出口和入口
3. 当IPv4转IPv6，把IPv4数据报的数据部分（即原来的 IPv6 数据报）交给主机IPv6协议栈

![](./4/隧道技术.png)

#### ICMPv6

IPv6也不保证数据报的可靠交付，会丢弃数据报，ICMPv6反馈差错信息，合并了地址解析协议ARP和网际组管理协议IGMP功能，ICMPv6面向报文，利用报文来报告差错、获取信息、探测邻站、管理多播通信，增加定义报文功能和含义的其他协议

分类：

1. 差错报文
2. 信息报文
3. 邻站发现报文（ND协议）
4. 组成员关系报文（MLD协议）



### IP多播

#### 基本概念

##### 优点

多播可大大节约网络资源，不需要重复发送副本

##### 地址

多播数据报用D类IP地址（多播组标识符）作为目的地址，并且首部中协议字段值为2，表明使用IGMP

##### 注意点&特性

多播数据报也是尽最大努力交付

多播地址只能用于目的地址，而不能用于源地址

对多播数据报不产生ICMP差错报文。

#### 局域网上硬件多播

IANA拥有的以太网地址块高24位为`00-00-5E`，因此 TCP/TP协议使用的以太网多播地址块的范围是`00-00-5E-00-00-00`到`00-00-5E-FF-FF-FF`

MAC地址的第1字节的最低位为1时即为多播地址，且占IANA分配的地址数一半，范围是`01-00-5E-00-00-00`到`01-00-5E-7F-FF-FF`，只有23位可用作多播

由于多播IP地址与以太网硬件地址的映射关系不是唯一的，因此收到多播数据报的主机，还要在IP层利用软件进行过滤，把不是本主机要接收的数据报丢弃

![](./4/IP多播映射.png)

#### 网际组管理IGMP

IGMP协议是让连接在**本地局域网上**的多播路由器知道**本局域网上**是否有主机（进程）参加或退出了某个多播组

目前版本IGMPv3，IGMP 使用 IP 数据报传递其报文，但它也向 IP 提供服务。

##### 工作流程

1. 主机加入时，向多播地址发送IGMP报文，声明自己，本地的多播路由器收到报文后，利用多播路由选择协议把当前组成员关系转发给互联网上的其他多播路由器
2. 本地多播路由器周期性（默认125秒）对所有组发送探寻报文（也允许单发），几次探寻中有一台主机对某个组响应就认为其活跃，否则认为全部离开，不再转发此组成员关系

##### 具体措施

1. 主机和多播路由器间都用IP多播，在支持硬件多播网络上，IGMP报文尽可能用硬件多播，因此未参加多播主机不会收到报文

3. 一个网络上有多个多播路由器时，能够迅速有效选择其中一个来探询主机的成员关系，不会引起IGMP通信量增大

4. IGMP询问报文中有一个数值N为最长响应时间（默认为10秒），收到询问时，主机在0到N之间随机选择发送响应所需时延。一台主机同时参加几个多播组，则主机对每一个多播组选择不同的随机数，最小时延响应最先发送

5. 同一个组内的每一台主机都要监听响应，只要有本组的其他主机先发送了响应，自己就可以不再发送响应了

6. 一台主机多个进程都加入某多播组，主机对发给多播组的每个数据报接收一个副本，然后复制给每个进程

   

#### 多播路由选择协议

多播路由选择实际上就是要找出以源主机为根节点的多播转发树，每一个多播路由器向树的叶节点方向转发收到的多播数据报，但在多播转发树上的路由器不会收到重复的多播数据报（即多播数据报不应在互联网中兜圈子）。不同的多播组、不同的源点都会有不同多播转发树。

##### 协议中主要方法

###### 洪泛与剪除——RPB

这种方法适合于较小的多播组，而所有的组成员接入的局域网也是相邻接的。
![](./4/RPB.png)

1. 一开始，路由器转发多播数据报使用洪泛的方法广播
2. 路由器收到多播数据报时，从本路由器寻找到源点最短路径的第一个路由器$R_1$是否为多播数据报送来的路由器，如果有多个$R_1$，选IP地址最小的
3. 若是，就向除进入方向的所有其他方向转发收到的多播数据报；否则丢弃

如果多播转发树上某路由器发现它的树枝已没有该多播组的成员，就应把它和下游的树枝一起剪除；又有成员的时候重新接入

###### 隧道技术IP-in-IP

隧道技术适用于多播组的位置在地理上很分散的情况，两个支持多播的网络中间需要经过不支持多播的网络。

路由器$R_1$对多播数据报加上普通数据报首部，封装为单播数据报。然后通过其他网络（隧道）发送到$R_2$，$R_2$剥去首部，恢复为原来多播数据报，继续向多个目的站转发
![](./4/多播隧道.png)

###### 基于核心的发现技术

这种方法对于多播组的大小在较大范围内变化时都适合。

1. 每一个多播组$G$指定一个核心路由器，给出它的IP单播地址
2. 核心路由器创建出多播组$G$的转发树
3. 路由器$R_1$向这个核心路由器发送数据报，那么途中经过的每一个路由器都要检查其内容，若这个路由器$R_2$参加了多播组$G$，就处理这个数据报
   1. 如果$R_1$发出的是一个多播数据报，其目的地址是$G$的组地址，$R_2$就向多播组$G$的成员转发这个多播数据报
   2. 如果$R_1$发出的数据报是一个请求加入多播组$G$的数据报，$R_2$就把这个信息加到它的路由中，并用隧道技术向$R_1$转发每一个多播数据报的一个副本

##### 真实协议

1. 距离向量多播路由选择协议`DVMRP`(Distance Vector Multicast Routing Protocol)：是在互联网上使用的第一个多播路由选择协议，UNIX系统中实现RIP的程序叫routed，mrouted使用DVMRP在路由器之间传播路由信息
2. 基于核心的转发树`CBT`(Core Based Tree)：使用核心路由器作为转发树的根节点，一个大自治系统可划分为几个区域，每一个区域选择一个核心路由器
3. 开放最短通路优先的多播扩展`MOSPF`(Multicast extensions to OSPF)：是单播路由选择协议OSPF的扩充，使用多播链路状态路由选择创建出基于源点的多播转发树
4. 协议无关多播-稀疏方式`PIM-SM`(Protocol Independent Multicast-Sparse Mode)：使用核心路由器作转发树根，虽然在建立多播转发树时是使用单播数据报来和远程路由器联系的，但不要求使用特定单播路由选择协议，适用于组成员的分布非常分散的情况
5. 协议无关多播-密集方式`PIM-DM`(Protocol Independent Multicast-Dense Mode)：使用洪泛方式转发数据报，适用于组成员的分布非常集中的情况



### VPN

#### 专用IP地址（可重用地址）

这些地址只能用于一个机构的内部通信，而不能用于和互联网上的主机通信：

1. 10.0.0.0到10.255.255.255（或记为 10.0.0.0/8，它又称为24位块）
2. 172.16.0.0到172.31.255.255（或记为172.16.0.0/12，它又称为20位块）
3. 192.168.0.0到192.168.255.255（或记为192.168.0.0/16，它又称为16位块）

#### VPN定义

利用公用的互联网作为本机构各专用网之间的通信载体的专用网，用于机构内部主机通信，VPN的每一个场所系统都需要知道其他场所地址

#### 工作流程

![](./4/VPN.png)

1. $X$想联系$Y$，先在本机构内部发送数据报到与互联网连接的路由器$R_1$，源地址$X$，目的地址$Y$
2. 路由器$R_1$收到内部数据报发现目的网络必须通过互联网才能到达，创建新数据报，首部中源地址是$R1$的全球地址、目的地址是$R_2$的全球地址，内部数据报加密放入数据部分，封装为互联网外部数据报
3. 路由器$R_2$收到数据报将数据部分取出解密，恢复原来内部数据报（源地址$X$，目的地址$Y$），在内部网络交付主机$Y$



### NAT&NAPT

下面讨论另一种情况，就是在专用网内部的一些主机本来已经分配到了本地 IP 地址（即仅在本专用网内使用的专用地址），但现在又想和互联网上的主机通信（并不需要加密），那么应当采取什么措施呢?

#### NAT路由器

1. 有NAT软件
2. 至少有一个有效外部全球IP地址

这样，所有使用本地地址的主机在和外界通信时，都要在 NAT 路由器上将其本地地址转换成全球 IP 地址，才能和互联网连接。

#### 工作流程

![](./4/NAT.png)

1. $A$想发报文给$B$， 源IP地址为$A$，目的IP地址为$B$
2. NAT路由器$R$在专用网内部收到$A$发给$B$数据报，把源IP地址$A$转换为$R$的全球地址转发
3. $B$收到这个数据报，发送应答的数据报目的IP地址是$R$的全球IP地址，源地址$B$
4. $R$收到$B$的数据报，通过NAT地址转换表，把应答数据报目的IP地址转换为$A$

#### NAT地址转换表

| 方向 |    字段    |  旧IP地址   |  新IP地址   |
| :--: | :--------: | :---------: | :---------: |
|  出  |  源IP地址  | 192.168.0.3 | 172.38.1.5  |
|  入  | 目的IP地址 | 172.38.1.5  | 192.168.0.3 |
|  出  |  源IP地址  | 192.168.0.7 | 172.38.1.6  |
|  入  | 目的IP地址 | 172.38.1.6  | 192.168.0.7 |

NAT路由器有$n$个全球IP地址，则专用网内最多同时有$n$台主机接入到互联网，主机较多需轮流使用地址，因此外部发起请求则不知道如何转化为内部地址，内部主机不能充当服务器用



#### NAPT地址转换表

| 方向 |        字段        | 旧IP地址与端口号  | 新IP地址与端口号  |
| :--: | :----------------: | :---------------: | :---------------: |
|  出  |   源IP:TCP源端口   | 192.168.0.3:30000 | 172.38.1.5:40001  |
|  出  |   源IP:TCP源端口   | 192.168.0.4:30000 | 172.38.1.5:40002  |
|  入  | 目的IP:TCP目的端口 | 172.38.1.5:40001  | 192.168.0.3:30000 |
|  入  | 目的IP:TCP目的端口 | 172.38.1.5:40002  | 192.168.0.4:30000 |

加上运输层端口号可使多个本地主机共用一个NAT路由器上的全球IP地址，同时和互联网上不同主机通信



#### 特殊点

1. 普通路由器转发IP数据报时，不改变源IP地址、目的IP地址；NAT路由器更换地址
2. 普通路由器转发分组工作在网络层；NAPT路由器查看转换运输层端口号，属于运输层



### MPLS

#### 基本概念

MPLS：多协议标记交换

LSR：同时具有标记交换和路由选择这两种功能，标记交换可快速转发，需要先使用路由选择功能构造转发表

MPLS域：该域中有许多彼此相邻的标记交换路由器LSR

显式路由选择：由入口LSR确定MPLS域内转发路径，像虚连接

#### MPLS特点

1. MPLS上层可以采用多种协议；下层可用多种链路层协议（如PPP、以太网、ATM、帧中继）
2. 支持面向连接的服务质量
3. 支持流量工程，平衡网络负载
4. 有效地支持VPN
5. 每个分组携带标记

#### 基本工作原理

![](./4/MPLS工作原理.png)

1. MPLS域的入口处给每个IP数据报加标记，然后

2. MPLS域中各LSR使用标记分配协议LDP交换报文，找出标记对应交换路径LSP，根据路径构造转发表

3. MPLS域入口给不同类IP数据报加标记，严格按照网络层分类只使用IP首部字段，但运营商用了运输层TCP或UDP首部端口号，甚至有应用层分类
   
4. 入口按照转发表把它转发给下一个LSR，以后所有LSR不再上升到第三层查找转发表，而是查找标记对换表把入标记更换成为出标记，在链路层用硬件进行转发，标记不全局通用，相邻LSR间沟通使用

   | 入接口 | 入标记 | 出接口 | 出标记 |
   | :----: | :----: | :----: | :----: |
   |   0    |   3    |   1    |   1    |

5. MPLS出口结点把MLPS标记去除，把IP数据报交付非MPLS的主机或路由器，按照普通的转发方法转发



#### 转发等价类FEC

##### 定义

路由器按照同样方式对待的IP数据报集合，从同样接口转发到同样下一跳地址，并且具有同样服务类别和同样丢弃优先级等。

##### 可能种类

1. 目的IP地址与某一个特定IP地址的前缀匹配的IP数据报的集合（普通路由器方式）
2. 所有源地址与目的地址都相同的IP数据报的集合
3. 具有某种服务质量需求IP数据报集合

##### 用途

1. MPLS入口结点对同样FEC的IP数据报指派同样标记。
2. FEC用于负载平衡的例子，这就可能导致这段最短路径过载。



#### 首部位置与格式

IP数据报先要插入MPLS首部再封装成以太网帧，以太网类型字段单播下为8847，多播下为8848，区分这个帧是否携带MPLS标记

![](./4/MPLS格式.png)

1. 标记值：20bit，理论可容纳$2^{20}$个流，但实际上不会这么多，通常管理员人工设置交换路径
2. 试验：3bit，目前保留用于试验
3. 栈S：1bit，在有标记栈时使用
4. 生存时间TTL：8bit，防止MPLS分组无限循环转发



## 第九章 无线网络和移动网络

### WLAN

便携站：便于移动，但工作时不移动

移动站：可任意移动

#### 固定基础设施类型

##### 概念

使用星形拓扑结构，中心是接入点AP，MAC层使用CSMA/CA协议，IEEE802.11系列WLAN成为Wi-Fi

802.11系列规定最小构件为基本服务集BSS：包括一个基站AP和若干移动站，所有的站在BSS内可直接通信，和以外的站通信必须经过BSS。所覆盖的范围称为基本服务区BSA

接入点AP：安装AP时需要给其分配不超过32字节的服务集标识符SSID和一个通信信道

分配系统DS：BSS可以通过AP连入DS，然后再连别的BSS，共同构成一个拓展服务集ESS。DS可以使ESS对上层表现像一个BSS一样。ESS中的不同BSS可能有相交部分。DS可以使用以太网（常用），点对点链路，或其他无线网络

门户Portal：相当于网桥，可以为无线局域网用户提供到802.x局域网即其他局域网的接入

![](./9/BSS.png)

##### 工作流程

1. 工作时移动站先与某AP建立关联，可以等待AP周期性发送信标帧（被动），也可以主动发出探测请求帧，等待AP发回探测响应帧
2. 让AP鉴别自身，再通过AP向该子网发送DHCP发现报文来获取IP地址，此时变成AP子网的一台主机。
3. 重建关联直接关联到另一个AP上，分离可以终止与AP连接



#### 无固定基础设施（移动自组网络）

##### 特点

没有基站，因此服务范围受限，一般不和其他外界网络连接，路由选择协议复杂，多播复杂

##### 无线传感器网络WSN

数据采集处理传输，不需要高带宽，要低功耗，存储受限，对安全、重组要求高，主要在物联网中应用

##### 概念

移动IP是用户以多种方式连接到互联网，仍基于固定互联网的路由选择协议

移动组网有自己的路由选择协议甚至可以不连到互联网，连上也是以残桩网络形式存在

残桩网络：可以发出和接受通信量，但不允许外部通信量穿越残桩网络

1. 固定接入：作为网络用户期间，用户设置地理位置不变
2. 移动接入：用户能够以车辆速度移动时进行网络通信，切换时连续
3. 便携接入：受限网络范围内，能以步行速度进行网络通信，切换时连续
4. 游牧接入：正在进行网络通信时保持位置不变，移动后再次寻找基站



#### 物理层

无线局域网适配器能适配很多标准，有双模三模



#### MAC层协议

##### 802.11使用CSMA/CA协议

无线环境碰撞检测问题：

1. 无线信道信号强度动态范围大，监听到的信号强度太小
2. 无法避免碰撞发生，如ABC为等边三角形，AC隔了一座山，检测不出信道上对方信号，都需要给B发送信号
3. 暴露站问题：ABCD一条线排列，BC想给A和D发送消息，认为产生了碰撞，但实际上并不影响（AD离得很远）
4. 可允许多个移动站之间同时通信

CA：尽量避免碰撞

停止等待协议：发送完一帧后需要等待对方确认帧才继续发下一帧，是链路层确认

##### 802.11的MAC层

MAC设计在物理层上，包括两个子层：

1. 分布协调功能DCF：没有任何控制中心，每个结点使用CSMA机制的分布式接入算法，向上提供争用服务，所有实现必须有DCF
2. 点协调功能：PCF可有可无，用接入点AP来控制整个BSS内的活动，集中控制类似轮询避免碰撞

等待一段帧间间隔IFS后，才能继续发送下一帧，高优先级帧需要时间短，低优先级需要时间长

![](./9/CSMA-CA.png)

###### 帧间隔类型

1. SIFS：短帧间间隔，28μs，是最短间隔，用来分隔开属于一次对话的各帧。一个站应当能在SIFS内从发送方式切换到接收方式。使用 SIFS 的帧类型有
   1. ACK 帧
   2. CTS 帧
   3. 由过长的 MAC 帧分片后的数据帧
   4. 所有回答 AP 探询的帧
   5. 在 PCF 方式中接入点 AP发 送出的任何帧

2. DIFS：分布协调功能帧间间隔，长度为 128μs。在 DCF 方式中，DIFS 用来发送数据帧和管理帧















### WPAN

